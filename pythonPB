# 'dataset' ya viene cargado.
import pandas as pd
from sklearn.ensemble import IsolationForest

# 1. Definimos tus columnas (Tal cual las tienes en tu código exitoso)
col_monto = 'ACF-MONTO EN MONEDA LOCAL'
col_hora = 'ACF-HORA SIN MINUTOS DE LA TRX'

# 2. LIMPIEZA BLINDADA (Aquí está la magia)
# Convertimos a string primero para asegurar, reemplazamos coma por punto (por si acaso) y luego a número.
dataset['Monto_Limpio'] = (dataset[col_monto].astype(str)
                           .str.replace(',', '.', regex=False)  # Parche para formato latino
                           .apply(pd.to_numeric, errors='coerce')
                           .fillna(0))

# Limpieza de Hora (Aseguramos que sea entero)
dataset['Hora_Num'] = pd.to_numeric(dataset[col_hora], errors='coerce').fillna(-1)

# 3. Preparamos los datos
# Filtramos solo lo que tenga sentido (monto y hora válidos)
datos_modelo = dataset[['Monto_Limpio', 'Hora_Num']].astype(float)

# 4. El Cerebro (Isolation Forest)
# contamination=0.02 es el 2% más raro
clf = IsolationForest(contamination=0.02, random_state=42)
prediccion = clf.fit_predict(datos_modelo)

# 5. Resultado
dataset['Es_Anomalia_IA'] = ["SI" if x == -1 else "NO" for x in prediccion]

# Power BI tomará este 'dataset' final.
