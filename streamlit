import streamlit as st
import polars as pl
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from sklearn.ensemble import IsolationForest
from sklearn.preprocessing import OrdinalEncoder

st.set_page_config(page_title="üõ°Ô∏è Monitor+ Expert Dashboard", layout="wide")

st.markdown("""
<style>
    .risk-high {background-color: #ffcccc; padding: 10px; border-radius: 5px;}
    .risk-med {background-color: #fff4cc; padding: 10px; border-radius: 5px;}
</style>
""", unsafe_allow_html=True)

st.title("üõ°Ô∏è Monitor+ Fraud Hunter: Deep Analytics")
st.markdown("**Fuente:** Journals Monitor Plus (ACF) | **Modelos:** Markov + Isolation Forest + Reglas Expertas (TVR/Entry Mode)")

# --- 1. CARGA Y PROCESAMIENTO ---
@st.cache_data
def load_data(uploaded_file):
    if uploaded_file is None: return None
    
    try:
        # Usamos Pandas para leer el Excel sucio (saltando 4 filas)
        # Ajusta 'header=4' si la fila 5 es la cabecera real
        df_pd = pd.read_excel(uploaded_file, header=4, dtype=str)
        df = pl.from_pandas(df_pd)
        
        # --- A. MAPEO DE COLUMNAS REALES (Basado en tus im√°genes) ---
        col_map = {
            "ACF-NUMERO DE TARJETA ENCRIPTADO AES": "pan",
            "ACF-MONTO ORIGINAL TRX": "monto",
            "ACF-FECHA TRX": "fecha",
            "ACF-HORA TRX": "hora",
            "ACF-NOMBRE/LOCALIZACION COMERCIO": "comercio_sucio",
            "ACF-COD RPTA": "resp_code",
            "ACF-ENTRY MODE": "entry_mode",
            "ACF-MCC +": "mcc",
            "SCORE DINAMICO": "score_monitor",     # Score del proveedor
            "ACF-TVR": "tvr",                    # Variable t√©cnica experta
            "CC : K07_COUNTD_APROBADAS": "velocity_daily_count" # Variable pre-calculada
        }
        
        # Filtramos y renombramos solo lo que existe
        available_cols = [c for c in col_map.keys() if c in df.columns]
        df = df.select(available_cols).rename({k:v for k,v in col_map.items() if k in available_cols})
        
        # --- B. LIMPIEZA Y CASTING ---
        df = df.with_columns([
            pl.col("monto").str.replace(",", "").cast(pl.Float64, strict=False).fill_null(0),
            pl.col("score_monitor").cast(pl.Float64, strict=False).fill_null(0),
            pl.col("velocity_daily_count").cast(pl.Float64, strict=False).fill_null(0)
        ])
        
        # Crear Datetime completo
        # Asumiendo formato DDMMAA o similar en Monitor, ajusta el format string si falla
        # Aqu√≠ concatenamos fecha y hora para tener precisi√≥n
        df = df.with_columns(
            (pl.col("fecha") + " " + pl.col("hora")).alias("datetime_str")
        )
        
        # Intentar conversi√≥n de fecha (Manejo de errores simple)
        try:
            df = df.with_columns(
                pl.col("datetime_str").str.to_datetime(format="%Y%m%d %H%M%S", strict=False).alias("timestamp")
            )
        except:
             # Fallback si el formato es distinto (ej. Excel serial date)
             df = df.with_columns(pl.lit(None).alias("timestamp"))

        # --- C. INGENIER√çA DE VARIABLES (FEATURE ENGINEERING) ---
        
        # 1. Limpieza de Comercio
        df = df.with_columns(
            pl.col("comercio_sucio").str.replace(r"[\*#].*$", "").str.strip_chars().alias("comercio")
        )
        
        # 2. Flag Banda Magn√©tica (Entry Mode empieza con 90 o 02)
        # Entry mode suele venir como '051', '901'. Tomamos los 2 primeros chars.
        df = df.with_columns(
            pl.col("entry_mode").str.slice(0, 2).alias("entry_mode_clean")
        )
        df = df.with_columns(
            pl.when(pl.col("entry_mode_clean").is_in(['90', '02', '80'])).then(1).otherwise(0).alias("is_risky_entry")
        )

        # 3. Categorizaci√≥n de Respuesta para Markov
        df = df.with_columns(
            pl.when(pl.col("resp_code") == "00").then(pl.lit("OK"))
            .when(pl.col("resp_code").is_in(["51", "61"])).then(pl.lit("NO_FONDOS"))
            .when(pl.col("resp_code").is_in(["N7", "55", "54"])).then(pl.lit("FRAUDE_TECNICO"))
            .otherwise(pl.lit("OTRO"))
            .alias("grupo_resp")
        )
        
        return df

    except Exception as e:
        st.error(f"Error procesando data: {e}")
        return None

# --- UI PRINCIPAL ---
uploaded_file = st.sidebar.file_uploader("Cargar Journal Monitor+ (Excel)", type=["xlsx"])
df = load_data(uploaded_file)

if df is not None:
    # --- MODELADO ---
    
    # 1. CADENAS DE MARKOV (Secuencialidad)
    # Ordenamos por tarjeta y tiempo (si timestamp fall√≥, usa √≠ndice original impl√≠cito)
    df = df.with_row_index("idx").sort(["pan", "idx"])
    
    df = df.with_columns([
        pl.col("grupo_resp").shift(1).over("pan").fill_null("START").alias("prev_resp"),
        pl.col("monto").shift(1).over("pan").fill_null(0).alias("prev_monto")
    ])
    
    df = df.with_columns(
        (pl.col("prev_resp") + " -> " + pl.col("grupo_resp")).alias("transicion")
    )
    
    # Calcular rareza de transici√≥n
    trans_counts = df.group_by("transicion").count()
    total = trans_counts["count"].sum()
    trans_probs = trans_counts.with_columns((pl.col("count")/total).alias("prob_markov"))
    df_scored = df.join(trans_probs, on="transicion", how="left")

    # 2. ISOLATION FOREST (Anomal√≠a Multivariada)
    # Usamos Score de Monitor + Monto + Velocity + Risk Entry
    X = df_scored.select(["monto", "score_monitor", "velocity_daily_count", "is_risky_entry"]).to_pandas().fillna(0)
    
    model = IsolationForest(contamination=0.02, random_state=42)
    df_scored = df_scored.with_columns(
        pl.Series(model.fit_predict(X)).alias("anomaly_if") # -1 es anomal√≠a
    )
    
    # 3. SCORE FINAL PROPIO
    # Combinamos: Score Monitor (Base) + Anomal√≠a IF + Rareza Markov + Regla Experta (Banda)
    df_scored = df_scored.with_columns(
        (
            (pl.col("score_monitor") * 0.5) + # Confiamos en Monitor+
            ((1 - pl.col("prob_markov")) * 200) + # Si la transici√≥n es rara, sube mucho
            pl.when(pl.col("anomaly_if") == -1).then(300).otherwise(0) +
            (pl.col("is_risky_entry") * 500) # Si es banda magn√©tica, castigo duro
        ).alias("MYKE_SCORE")
    )

    # --- DASHBOARD ---
    
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("Total Tx", df.height)
    c2.metric("Monto Total", f"S/ {df['monto'].sum():,.2f}")
    c3.metric("Banda Magn√©tica/Fallback", df.filter(pl.col("is_risky_entry") == 1).height, delta_color="inverse")
    c4.metric("N7 Detectados", df.filter(pl.col("resp_code") == "N7").height, delta_color="inverse")

    tab1, tab2, tab3 = st.tabs(["üö® Alertas Prioritarias", "üß† An√°lisis Avanzado", "üìä Distribuciones"])
    
    with tab1:
        st.subheader("Top Transacciones para Bloqueo Inmediato")
        st.markdown("Ordenado por **Myke Score** (Combinaci√≥n de Monitor+, IA y Reglas).")
        
        umbral = st.slider("Sensibilidad de Score", 0, 2000, 800)
        
        top_risk = df_scored.filter(pl.col("MYKE_SCORE") > umbral).sort("MYKE_SCORE", descending=True)
        
        st.dataframe(
            top_risk.select([
                "pan", "monto", "comercio", "resp_code", "entry_mode", 
                "transicion", "score_monitor", "MYKE_SCORE"
            ]).to_pandas(),
            use_container_width=True
        )
        
    with tab2:
        c_a, c_b = st.columns(2)
        with c_a:
            st.subheader("Relaci√≥n: Score Monitor vs. Anomal√≠a Detectada")
            fig_sc = px.scatter(
                df_scored.sample(min(5000, df.height)).to_pandas(),
                x="score_monitor", y="monto", color="anomaly_if",
                title="¬øCoincide nuestra IA con Monitor Plus?",
                color_discrete_map={1: "blue", -1: "red"} # Rojo = Anomal√≠a nuestra
            )
            st.plotly_chart(fig_sc, use_container_width=True)
            
        with c_b:
            st.subheader("Matriz de Transici√≥n (Markov)")
            heatmap_data = df_scored.pivot(values="monto", index="prev_resp", columns="grupo_resp", aggregate_function="count").fill_null(0)
            z = heatmap_data.select(pl.all().exclude("prev_resp")).to_numpy()
            x = heatmap_data.columns[1:]
            y = heatmap_data["prev_resp"].to_list()
            
            fig_heat = go.Figure(data=go.Heatmap(z=z, x=x, y=y, colorscale='Viridis'))
            fig_heat.update_layout(title="Patrones de Ataque (Ej: N7 -> OK)")
            st.plotly_chart(fig_heat, use_container_width=True)

    with tab3:
        st.subheader("Entry Mode: ¬øEst√°s recibiendo ataques de clonaci√≥n?")
        fig_bar = px.bar(df_scored.group_by("entry_mode_clean").count().to_pandas(), x="entry_mode_clean", y="count")
        st.plotly_chart(fig_bar)

else:
    st.info("Esperando archivo Monitor Plus...")
