import streamlit as st
import polars as pl
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from sklearn.ensemble import IsolationForest
from sklearn.preprocessing import OrdinalEncoder

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(page_title="üõ°Ô∏è Monitor+ Fraud Hunter", layout="wide", initial_sidebar_state="expanded")

# Estilos CSS para resaltar alertas
st.markdown("""
<style>
    .metric-card {background-color: #f0f2f6; border-left: 5px solid #ff4b4b; padding: 10px; border-radius: 5px;}
    .stTabs [data-baseweb="tab-list"] {gap: 10px;}
    .stTabs [data-baseweb="tab"] {height: 50px; white-space: pre-wrap; background-color: #f0f2f6; border-radius: 5px;}
    .stTabs [aria-selected="true"] {background-color: #ff4b4b; color: white;}
</style>
""", unsafe_allow_html=True)

st.title("üõ°Ô∏è Monitor+ Fraud Hunter: An√°lisis Forense")
st.markdown("**Anal√≠tica:** Polars + Markov Chains + Isolation Forest | **Input:** Journal Monitor Plus (Excel)")

# --- 1. FUNCI√ìN DE CARGA Y PROCESAMIENTO ---
@st.cache_data
def load_and_process_data(uploaded_file):
    if uploaded_file is None: return None
    
    try:
        # A. LECTURA CON PANDAS (Saltando basura)
        # header=4: El encabezado real est√° en la fila 5 (√≠ndice 4)
        # dtype=str: Leemos todo como texto para evitar errores de formato en tarjetas
        df_pd = pd.read_excel(uploaded_file, header=4, dtype=str)
        df = pl.from_pandas(df_pd)
        
        # B. MAPEO DE COLUMNAS (Tus nombres reales vs Nombres internos)
        col_map = {
            "ACF-NUMERO DE TARJETA ENCRIPTADO AES": "pan",
            "ACF-MONTO ORIGINAL TRX": "monto",
            "ACF-FECHA TRX": "fecha",
            "ACF-HORA TRX": "hora",
            "ACF-NOMBRE/LOCALIZACION COMERCIO": "comercio_sucio",
            "ACF-COD RPTA": "resp_code",
            "ACF-ENTRY MODE": "entry_mode",
            "ACF-MCC +": "mcc",
            "SCORE DINAMICO": "score_monitor",     
            "ACF-TVR": "tvr",
            "CC : K07_COUNTD_APROBADAS": "velocity_count" # Contador pre-calculado de Monitor
        }
        
        # Filtrar solo columnas existentes para evitar errores
        avail_cols = [c for c in col_map.keys() if c in df.columns]
        df = df.select(avail_cols).rename({k:v for k,v in col_map.items() if k in avail_cols})
        
        # C. LIMPIEZA Y CASTING
        # Limpiar montos (quitar comas) y scores
        df = df.with_columns([
            pl.col("monto").str.replace(",", "").cast(pl.Float64, strict=False).fill_null(0),
            pl.col("score_monitor").cast(pl.Float64, strict=False).fill_null(0)
        ])
        
        if "velocity_count" in df.columns:
            df = df.with_columns(pl.col("velocity_count").cast(pl.Float64, strict=False).fill_null(0))
        else:
            df = df.with_columns(pl.lit(0).alias("velocity_count"))

        # D. INGENIER√çA DE VARIABLES (Feature Engineering)
        
        # 1. Limpieza de Comercio
        df = df.with_columns(
            pl.col("comercio_sucio")
            .str.replace(r"^(IZIPAY|NIUBIZ|CULQI)\s*", "")
            .str.replace(r"[\*#].*$", "")
            .str.strip_chars()
            .alias("comercio")
        )
        
        # 2. Detecci√≥n de Banda Magn√©tica / Clonaci√≥n
        # Si Entry Mode empieza con '90', '02' o '80' (Fallback), es riesgo alto
        df = df.with_columns(
            pl.col("entry_mode").str.slice(0, 2).alias("entry_mode_short")
        )
        df = df.with_columns(
            pl.when(pl.col("entry_mode_short").is_in(['90', '02', '80'])).then(1).otherwise(0).alias("is_magnetic_stripe")
        )
        
        # 3. Categorizaci√≥n de Respuesta para Markov
        # Agrupamos los 100+ c√≥digos en 4 familias l√≥gicas
        df = df.with_columns(
            pl.when(pl.col("resp_code") == "00").then(pl.lit("APROBADO"))
            .when(pl.col("resp_code").is_in(["51", "61", "65"])).then(pl.lit("NO_FONDOS"))
            .when(pl.col("resp_code").is_in(["N7", "55", "54", "14", "75"])).then(pl.lit("FRAUDE_TECNICO")) # Ojo aqu√≠
            .otherwise(pl.lit("OTRO_ERROR"))
            .alias("grupo_resp")
        )
        
        # 4. Creaci√≥n de Secuencias (Markov)
        # Ordenamos por tarjeta para ver la historia
        # Usamos row_index como proxy de tiempo si la fecha falla
        df = df.with_row_index("idx").sort(["pan", "idx"])
        
        df = df.with_columns([
            pl.col("grupo_resp").shift(1).over("pan").fill_null("START").alias("prev_resp"),
            pl.col("monto").shift(1).over("pan").fill_null(0).alias("prev_monto")
        ])
        
        df = df.with_columns(
            (pl.col("prev_resp") + " -> " + pl.col("grupo_resp")).alias("transicion_markov")
        )
        
        return df

    except Exception as e:
        st.error(f"Error cr√≠tico procesando el archivo: {e}")
        return None

# --- SIDEBAR: CONTROLES ---
st.sidebar.header("üìÇ Panel de Control")
uploaded_file = st.sidebar.file_uploader("Cargar Journal (Excel)", type=["xlsx"])

if uploaded_file is not None:
    with st.spinner("Procesando millones de datos con Polars..."):
        df = load_and_process_data(uploaded_file)
    
    if df is not None:
        # --- MODELADO (SE ENTRENA CON TODA LA DATA) ---
        
        # 1. Markov Scoring (Rareza de Transici√≥n)
        trans_counts = df.group_by("transicion_markov").count()
        total_trans = trans_counts["count"].sum()
        trans_probs = trans_counts.with_columns((pl.col("count")/total_trans).alias("prob_markov"))
        df_scored = df.join(trans_probs, on="transicion_markov", how="left")
        
        # 2. Isolation Forest (Anomal√≠as)
        # Features: Monto, Velocity, Score Monitor, Banda Magn√©tica
        X = df_scored.select(["monto", "velocity_count", "score_monitor", "is_magnetic_stripe"]).to_pandas().fillna(0)
        model_if = IsolationForest(contamination=0.03, random_state=42)
        df_scored = df_scored.with_columns(
            pl.Series(model_if.fit_predict(X)).alias("anomaly_if") # -1 es anomal√≠a
        )
        
        # 3. MYKE SCORE (Score H√≠brido Final)
        # F√≥rmula: Monitor(30%) + Markov(Rareza)(30%) + ML(Anomal√≠a)(20%) + ReglaBanda(20%)
        df_scored = df_scored.with_columns(
            (
                (pl.col("score_monitor") * 0.5) + 
                ((1 - pl.col("prob_markov")) * 300) + 
                pl.when(pl.col("anomaly_if") == -1).then(400).otherwise(0) +
                (pl.col("is_magnetic_stripe") * 800) # Penalizaci√≥n m√°xima por banda magn√©tica
            ).alias("MYKE_SCORE")
        )

        # --- FILTRO POR COMERCIO (PARA EL AN√ÅLISIS INDIVIDUAL) ---
        st.sidebar.divider()
        st.sidebar.subheader("üîç Filtro de An√°lisis")
        
        # Lista de comercios ordenada alfab√©ticamente
        comercios_list = ["TODOS"] + sorted(df_scored["comercio"].unique().to_list())
        comercio_sel = st.sidebar.selectbox("Seleccionar Comercio a Auditar:", comercios_list)
        
        # Filtrar datos para visualizaci√≥n
        if comercio_sel != "TODOS":
            df_view = df_scored.filter(pl.col("comercio") == comercio_sel)
        else:
            df_view = df_scored
            
        # --- DASHBOARD ---
        
        # KPIs Superiores
        kpi1, kpi2, kpi3, kpi4 = st.columns(4)
        kpi1.metric("Transacciones", f"{df_view.height:,}")
        kpi2.metric("Monto Total", f"S/ {df_view['monto'].sum():,.2f}")
        
        # Conteo de N7 (Card Testing)
        cant_n7 = df_view.filter(pl.col("resp_code") == "N7").height
        kpi3.metric("Intentos N7 (Testing)", cant_n7, delta="Alerta" if cant_n7 > 5 else None, delta_color="inverse")
        
        # Conteo de Banda Magn√©tica
        cant_banda = df_view.filter(pl.col("is_magnetic_stripe") == 1).height
        kpi4.metric("Banda Magn√©tica (Clonaci√≥n)", cant_banda, delta="Cr√≠tico" if cant_banda > 0 else None, delta_color="inverse")

        # Pesta√±as
        tab1, tab2, tab3, tab4 = st.tabs(["üö® Matriz de Riesgo", "üîó Cadenas de Markov", "üí≥ Modo de Entrada", "üìß Decisi√≥n & Correo"])

        with tab1:
            st.subheader("Matriz de Riesgo: Score vs Monto")
            st.caption("Los puntos rojos son anomal√≠as detectadas por IA. El eje X es el Score Monitor+.")
            
            fig = px.scatter(
                df_view.to_pandas(),
                x="score_monitor", 
                y="monto", 
                color="anomaly_if",
                size="is_magnetic_stripe", # Puntos m√°s grandes si es banda magn√©tica
                hover_data=["pan", "resp_code", "transicion_markov", "MYKE_SCORE"],
                color_discrete_map={1: "blue", -1: "red"},
                title=f"Perfil de Riesgo: {comercio_sel}"
            )
            st.plotly_chart(fig, use_container_width=True)
            
            st.write("#### Top Transacciones Riesgosas (Myke Score)")
            st.dataframe(
                df_view.sort("MYKE_SCORE", descending=True)
                .select(["pan", "fecha", "monto", "resp_code", "entry_mode", "transicion_markov", "MYKE_SCORE"])
                .head(20).to_pandas(),
                use_container_width=True
            )

        with tab2:
            st.subheader("An√°lisis de Secuencia (Markov)")
            st.caption("Si ves cuadros amarillos/verdes en la columna 'APROBADO' viniendo de 'FRAUDE_TECNICO', es un ataque exitoso.")
            
            heatmap_data = df_view.pivot(values="monto", index="prev_resp", columns="grupo_resp", aggregate_function="count").fill_null(0)
            if not heatmap_data.is_empty():
                z = heatmap_data.select(pl.all().exclude("prev_resp")).to_numpy()
                x = heatmap_data.columns[1:]
                y = heatmap_data["prev_resp"].to_list()
                
                fig_heat = go.Figure(data=go.Heatmap(z=z, x=x, y=y, colorscale='Viridis', text=z, texttemplate="%{text}"))
                fig_heat.update_layout(title="Mapa de Transiciones")
                st.plotly_chart(fig_heat, use_container_width=True)
            else:
                st.info("No hay suficientes datos para generar el mapa de calor.")

        with tab3:
            st.subheader("An√°lisis de Clonaci√≥n (Entry Mode)")
            entry_counts = df_view.group_by("entry_mode").count().sort("count", descending=True).to_pandas()
            
            c_chart, c_exp = st.columns([2, 1])
            with c_chart:
                fig_bar = px.bar(entry_counts, x="entry_mode", y="count", color="entry_mode", title="Distribuci√≥n de Modos de Entrada")
                st.plotly_chart(fig_bar, use_container_width=True)
            
            with c_exp:
                st.info("""
                **Gu√≠a R√°pida:**
                * **051 / 052**: Chip (Seguro)
                * **071**: Contactless (Seguro)
                * **901 / 021**: Banda Magn√©tica (**ALERTA CLONACI√ìN**)
                * **80x**: Fallback (**ALERTA CHIP DA√ëADO/FORZADO**)
                """)

        with tab4:
            st.subheader("Generador de Decisi√≥n")
            
            riesgo_n7 = cant_n7 > 10
            riesgo_clonacion = cant_banda > 0
            riesgo_ia = df_view.filter((pl.col("anomaly_if") == -1) & (pl.col("monto") > 500)).height > 0
            
            if riesgo_n7:
                st.error("üî¥ **RECOMENDACI√ìN: BLOQUEO INMEDIATO (Card Testing)**")
                st.code(f"""
ASUNTO: Bloqueo Preventivo - {comercio_sel}

Hola,
Solicitamos el bloqueo del comercio {comercio_sel} por Card Testing.
Evidencia: {cant_n7} transacciones con c√≥digo N7 (CVV Inv√°lido) y patrones secuenciales an√≥malos.
                """)
            
            elif riesgo_clonacion:
                st.error("üî¥ **RECOMENDACI√ìN: BLOQUEO INMEDIATO (Clonaci√≥n)**")
                st.code(f"""
ASUNTO: Alerta de Fraude (Clonaci√≥n) - {comercio_sel}

Hola,
Solicitamos desafiliaci√≥n de {comercio_sel}.
Evidencia: Uso de Banda Magn√©tica (Entry Mode 90/02) en {cant_banda} transacciones, indicativo de Skimming.
                """)
                
            elif riesgo_ia:
                st.warning("üü° **RECOMENDACI√ìN: BLOQUEO PREVENTIVO (Anomal√≠a)**")
                st.code(f"""
ASUNTO: Revisi√≥n de Riesgo - {comercio_sel}

Hola,
Detectamos comportamiento an√≥malo en {comercio_sel}.
Evidencia: Montos y horarios fuera del perfil habitual (Score de Anomal√≠a Alto). Recomendamos bloqueo preventivo.
                """)
            
            else:
                st.success("üü¢ **RECOMENDACI√ìN: NO BLOQUEAR**")
                st.write("El comercio tiene alto volumen pero indicadores t√©cnicos sanos.")

else:
    st.info("üëã Sube el archivo Excel de Monitor Plus para comenzar.")
