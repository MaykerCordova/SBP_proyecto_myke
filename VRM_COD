# --- 1. SELECCIÃ“N DE COLUMNAS ACTUALIZADA ---
columnas_finales = [
    'Fecha', 'MONTO USD', 'TIPO DE MONEDA',
    'NOMBRE REGLA', 'CODIGO REGLA',
    'CALIFICACION', 'Gestion', # <--- Ahora sabemos que esto es el ESTADO
    'BIN', 'MCC', 'NOMBRE DE COMERCIO',
    'CODIGO PAIS', 'LOCALIDAD',
    'ENTRY MODE', 'ECI', 'Entidad',
    'COD REDP 59', 'TIPO DE TOKEN', 'NUMERO DE TOKEN' # <--- Agregadas por tu solicitud
]

# Creamos el DF limpio
df_clean = df[columnas_finales].copy()

# --- 2. LIMPIEZA Y FORMATO ---
# Convertir Fecha
df_clean['Fecha'] = pd.to_datetime(df_clean['Fecha'], errors='coerce')

# --- 3. INGENIERÃA DE VARIABLES (Nivel Senior) ---

# A. ClasificaciÃ³n de Eficiencia (Basado en tu columna CALIFICACION)
# Esto te permitirÃ¡ contar rÃ¡pido en Power BI
def clasificar_estado(estado):
    estado = str(estado).upper().strip()
    if 'FRAUDE' in estado: return 'Fraude Confirmado'
    elif 'BUENA' in estado: return 'Falso Positivo' # Regla saltÃ³, pero cliente era bueno
    elif 'PENDIENTE' in estado: return 'En InvestigaciÃ³n'
    elif 'NUEVA' in estado: return 'Sin Gestionar'
    else: return 'Otros'

df_clean['Estado_Analisis'] = df_clean['CALIFICACION'].apply(clasificar_estado)

# B. Flags NumÃ©ricos (Para hacer sumas rÃ¡pidas en Power BI)
# Truco: Crear columnas de 1 y 0 facilita calcular tasas % luego.
df_clean['Es_Fraude'] = df_clean['Estado_Analisis'].apply(lambda x: 1 if x == 'Fraude Confirmado' else 0)
df_clean['Es_FalsoPositivo'] = df_clean['Estado_Analisis'].apply(lambda x: 1 if x == 'Falso Positivo' else 0)

# C. Rango de Hora (Mantiene la lÃ³gica anterior)
def categorizar_hora(fecha):
    if pd.isnull(fecha): return 'Desconocido'
    h = fecha.hour
    if 0 <= h < 6: return 'Madrugada (0-6)'
    elif 6 <= h < 12: return 'MaÃ±ana (6-12)'
    elif 12 <= h < 18: return 'Tarde (12-18)'
    else: return 'Noche (18-24)'

df_clean['Franja_Horaria'] = df_clean['Fecha'].apply(categorizar_hora)

# D. Flag Internacional
df_clean['Es_Internacional'] = df_clean['CODIGO PAIS'].apply(lambda x: 'NO' if str(x).strip() in ['PE', 'PER', '604'] else 'SI')

# --- 4. GUARDADO ---
print("Generando Data_VRM_Final.parquet...")
df_clean.to_parquet("Data_VRM_Final.parquet", index=False)


#### VERSION 2
import pandas as pd
import pyodbc
import numpy as np

# =============================================================================
# 1. CONFIGURACIÃ“N Y CONEXIÃ“N
# =============================================================================
ruta_db = r'C:\Users\TuUsuario\Documents\Analisis_VRM.accdb' # <--- Actualiza tu ruta
nombre_tabla = 'NombreDeTuTabla'                              # <--- Actualiza tu tabla
ruta_salida_parquet = r'C:\Users\TuUsuario\Documents\Data_VRM_Clean.parquet'

print("ðŸ”„ Conectando a Access...")
try:
    conn_str = (r'DRIVER={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=' + ruta_db + ';')
    conn = pyodbc.connect(conn_str)
    query = f"SELECT * FROM {nombre_tabla}"
    df = pd.read_sql(query, conn)
    conn.close()
    print(f"âœ… Datos cargados: {len(df)} filas.")
except Exception as e:
    print(f"âŒ Error crÃ­tico de conexiÃ³n: {e}")
    exit()

# =============================================================================
# 2. LIMPIEZA Y NORMALIZACIÃ“N (El arreglo del problema de texto)
# =============================================================================
# Asumimos que la columna se llama 'CalificaciÃ³n'. CÃ¡mbialo si es distinto.
col_status = 'CalificaciÃ³n' 

# A. Limpieza de texto (MayÃºsculas y sin espacios)
# Si hay nulos, los rellenamos con 'DESCONOCIDO' para que no falle el cÃ³digo
df[col_status] = df[col_status].fillna('DESCONOCIDO').astype(str)
df['Status_Clean'] = df[col_status].str.upper().str.strip()

# =============================================================================
# 3. CREACIÃ“N DE COLUMNAS PARA POWER BI (IngenierÃ­a de datos)
# =============================================================================
# AquÃ­ preparamos el terreno para que tus medidas DAX sean fÃ¡ciles.

# DEFINICIÃ“N DE CATEGORÃAS
# Ajusta estas listas si tus nombres en Access son ligeramente diferentes
estados_fraude = ['PRIVADA']
estados_fp = ['BUENA']     # Falso Positivo
estados_pend = ['PENDIENTE']
estados_nuevos = ['NUEVA']

# A. Columna: ClasificaciÃ³n Simple (Para Filtros Visuales)
conditions = [
    df['Status_Clean'].isin(estados_fraude),
    df['Status_Clean'].isin(estados_fp),
    df['Status_Clean'].isin(estados_pend),
    df['Status_Clean'].isin(estados_nuevos)
]
choices = ['Fraude', 'Falso Positivo', 'Pendiente', 'Nuevo']

# Si no cae en ninguno, ponemos 'Otro'
df['Categoria_Final'] = np.select(conditions, choices, default='Otro')

# B. Columna: Grupo de AnÃ¡lisis (La soluciÃ³n a tu problema de Ratios)
# Esto permite filtrar en Power BI: Â¿Quiero ver PrecisiÃ³n o Carga Laboral?
conditions_grupo = [
    df['Status_Clean'].isin(estados_fraude + estados_fp), # Casos Cerrados
    df['Status_Clean'].isin(estados_pend + estados_nuevos) # Casos Abiertos
]
choices_grupo = ['Cerrado (Precision)', 'Abierto (Backlog)']
df['Grupo_Status'] = np.select(conditions_grupo, choices_grupo, default='Ignorar')

# C. Columna Bandera NumÃ©rica (Para facilitar sumas en DAX)
# 1 si es fraude, 0 si no.
df['Flag_Fraude'] = np.where(df['Status_Clean'].isin(estados_fraude), 1, 0)
# 1 si es caso cerrado, 0 si no (SerÃ¡ tu denominador en DAX)
df['Flag_Cerrado'] = np.where(df['Status_Clean'].isin(estados_fraude + estados_fp), 1, 0)

# =============================================================================
# 4. EXPORTACIÃ“N A PARQUET
# =============================================================================
print("ðŸ’¾ Guardando archivo Parquet...")

# Convertimos columnas de fecha a datetime si existen (Opcional, pero recomendado)
# if 'Fecha' in df.columns:
#     df['Fecha'] = pd.to_datetime(df['Fecha'])

# Guardamos
try:
    df.to_parquet(ruta_salida_parquet, index=False)
    print(f"âœ… Archivo exportado exitosamente en: {ruta_salida_parquet}")
    print("ðŸš€ Listo para importar en Power BI.")
except Exception as e:
    print(f"âŒ Error al guardar Parquet (Verificar librerÃ­a pyarrow/fastparquet): {e}")


### CALENDARIO VRM
Calendario = 
ADDCOLUMNS (
    // 1. Detecta automÃ¡ticamente la primera y Ãºltima fecha de tu data
    CALENDARAUTO(), 
    
    // --- COLUMNAS ESTÃNDAR ---
    "AÃ±o", YEAR([Date]),
    "Mes Nro", MONTH([Date]),
    "Mes Nombre", FORMAT([Date], "MMMM"),
    
    // Lo que pediste: Abreviatura en MayÃºsculas (ENE, FEB, MAR)
    "Mes Corto", UPPER(FORMAT([Date], "MMM")), 
    
    // Para ordenar grÃ¡ficos cronolÃ³gicamente (202501, 202502)
    "Periodo Sort", FORMAT([Date], "YYYYMM"),
    
    "DÃ­a Semana Nro", WEEKDAY([Date], 2), // 1=Lunes, 7=Domingo
    "DÃ­a Semana", FORMAT([Date], "dddd"),
    "DÃ­a Corto", UPPER(FORMAT([Date], "ddd")), // LUN, MAR, MIE
    
    // --- COLUMNAS FISCALES (Estilo Scotiabank / CanadÃ¡ Bancario) ---
    // El aÃ±o fiscal suele empezar el 1 de Noviembre.
    // Si estamos en Nov(11) o Dic(12), pertenece al aÃ±o siguiente.
    "AÃ±o Fiscal", 
        IF(
            MONTH([Date]) >= 11, 
            YEAR([Date]) + 1, 
            YEAR([Date])
        ),
    
    // Trimestre Fiscal (Q1 arranca en Noviembre)
    "Q Fiscal", 
        "Q" & SWITCH(
            TRUE(),
            MONTH([Date]) IN {11, 12, 1}, 1,
            MONTH([Date]) IN {2, 3, 4}, 2,
            MONTH([Date]) IN {5, 6, 7}, 3,
            4 // Meses 8, 9, 10
        )
)
